<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
    </style>
    <script type="text/javascript">
      function draw(geo_data) {
        "use strict";
        var margin = 75,
            width = 1400 - margin,
            height = 600 - margin;

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('class', 'map');

        var projection = d3.geo.mercator()
                               .scale(140)
                               .translate([width / 2, height / 1.2]);

        var path = d3.geo.path().projection(projection);

        var map = svg.selectAll('path')
                     .data(geo_data.features)
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .style('fill', 'lightBlue')
                     .style('stroke', 'black')
                     .style('stroke-width', 0.5);

        function plot_points(data) {
            //draw circles logic
            //debugger;
            function agg_year_country(leaves) {
              //console.log("leaves object=")
              //console.log(leaves)
               //debugger;
               //var user=[]
               //var  total_user=leaves.forEach(function(d){
                   //console.log(d["Value"]);
                   //user.push(+d["Value"])
                   //return user //+d["Value"]
               //});
                var total_user=d3.sum(leaves, function(d){
                  //console.log(d["Value"]);
                    return +d["Value"]
              });
               var coord=leaves.map(function(d){
                  //console.log(d.longitude)
                 return projection([+d.longitude, +d.latitude])
               });
               var center_x = d3.mean(coord,function(d){
                 //console.log(d[0]) //in pixels
                   return d[0]
               });
               var center_y = d3.mean(coord,function(d){
                 //console.log(d[1])
                   return d[1]
               });
               return{
                 'total_user':total_user,

                 'x':center_x,
                 'y':center_y,
               };

            }
            var nested = d3.nest()
                            //debugger;
                            //console.log(nested)
                           .key(function(d) {
                             //console.log(nested)
                             //console.log(d)
                              //debugger;
                              return d['Year'];
                            })
                            .key(function(d){
                              return d['name'];
                            })//.getUTCFullYear();

                           //})
                           //console.log(nested)
                           //debugger;
                           .rollup(agg_year_country) /*{
                             //console.log("leaves object=")
                             //console.log(leaves)
                              //debugger;
                              //var user=[]
                              //var  total_user=leaves.forEach(function(d){
                                  //console.log(d["Value"]);
                                  //user.push(+d["Value"])
                                  //return user //+d["Value"]
                              //});
                               var total_user=d3.sum(leaves, function(d){
                                 //console.log(d["Value"]);
                                   return +d["Value"]
                             });
                              var coord=leaves.map(function(d){
                                 //console.log(d.longitude)
                                return projection([+d.longitude, +d.latitude])
                              });
                              var center_x = d3.mean(coord,function(d){
                                //console.log(d[0]) //in pixels
                                  return d[0]
                              });
                              var center_y = d3.mean(coord,function(d){
                                //console.log(d[1])
                                  return d[1]
                              });
                              return{
                                'total_user':total_user,

                                'x':center_x,
                                'y':center_y,
                              };

                           })*/
                           .entries(data);
                           //debugger;
                           var user_extent=d3.extent(nested,function(d){
                               return d.values['total_user'];
                           });
                           var radius = d3.scale.sqrt()
                               .domain(user_extent)
                               .range([0,12]);

                           svg.append('g')
                              .attr("class", "bubble")
                              .selectAll("circle")
                              .data(nested)
                              .enter()
                              .append("circle")
                              .attr('cx',function(d,i){
                                return d.values['x'];})
                              .attr('cy',function(d,i){
                                 return d.values['y'];})
                              .attr("r",5)
                              //.attr('r',function(d){return radius(d.values['total_user']);})
                              .attr('fill','rgb(247,328,98)')
                              .attr('stroke','green')
                              .attr('stroke-width',0.7)
                              .attr('opacity',0.8);
                              debugger;
        };

        var format = d3.time.format("%Y");

        d3.csv("updated_data.csv", function(d) {
             d['Value'] = +d['Value'];
             d['Year'] = d['Year']//format.parse(d['Year']);
          return d;
        }, plot_points);
      };
      </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */

d3.json("world_countries.json", draw);
  </script>
</body>
</html>
